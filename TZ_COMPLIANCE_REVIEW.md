# Проверка соответствия ТЗ

## Критические несоответствия

### 1. ❌ Одна ставка на пользователя на весь аукцион

**ТЗ требует:**
- Одна ставка на пользователя на **весь аукцион** (не на раунд)
- SADD должен проверяться **ДО** размещения ставки
- Если SADD возвращает 0 → пользователь уже сделал ставку → **отклонение**

**Текущая реализация:**
- SADD вызывается **ПОСЛЕ** размещения ставки (строка 135 в bidService.ts)
- Позволяет делать несколько ставок в одном раунде (overbidding)
- Проверяет существующую ставку только в текущем раунде, а не во всем аукционе

**Исправление:**
1. Переместить проверку SADD в начало метода `placeBid`
2. Если SADD возвращает 0, сразу отклонять ставку
3. Убрать логику overbidding (замены ставки в раунде)
4. Проверять ставку на уровне всего аукциона, а не раунда

### 2. ❌ Anti-sniping механизм отсутствует

**ТЗ требует:**
- Защита от ставок в последний момент (anti-sniping)
- Блокировка ставок в последние N секунд раунда

**Текущая реализация:**
- Нет проверки времени до окончания раунда
- Ставки принимаются до самого конца раунда

**Исправление:**
1. Добавить проверку времени до окончания раунда
2. Блокировать ставки в последние 10 секунд (или настраиваемое значение)
3. Возвращать ошибку "Bids are not accepted in the last N seconds"

### 3. ⚠️ Персистентность ставок между раундами

**ТЗ требует:**
- Одна ставка на пользователя на весь аукцион
- Ставка должна использоваться во всех раундах

**Текущая реализация:**
- Ставки хранятся по раундам: `auction:{id}:round:{n}:bids`
- При переходе к новому раунду ставки не переносятся

**Вопрос:** Нужно ли копировать ставки в каждый раунд, или хранить на уровне аукциона?

**Вариант 1:** Хранить ставки на уровне аукциона
- `auction:{id}:bids` вместо `auction:{id}:round:{n}:bids`
- Settlement использует все ставки для каждого раунда

**Вариант 2:** Копировать ставки в каждый раунд при его создании
- При создании нового раунда копировать все ставки из предыдущего
- Settlement использует ставки текущего раунда

### 4. ⚠️ Settlement логика

**ТЗ требует:**
- Settlement для каждого раунда использует все ставки (одну на пользователя)
- Победители определяются по топ-N ставкам

**Текущая реализация:**
- Settlement использует ставки только текущего раунда
- Если ставки хранятся по раундам, нужно убедиться, что они копируются

### 5. ⚠️ Recovery логика

**ТЗ требует:**
- Восстановление ставок при рестарте сервера

**Текущая реализация:**
- Восстанавливает ставки только для текущего раунда
- Если ставки должны быть на уровне аукциона, нужно исправить

## Дополнительные проверки

### 6. ✅ Балансы и финансы
- Заморозка средств работает корректно
- Возврат средств проигравшим работает
- Списание средств победителям работает
- Нет двойных списаний

### 7. ✅ Переходы между раундами
- Раунды создаются корректно
- Таймеры работают правильно
- Settlement вызывается автоматически
- Переход к следующему раунду происходит автоматически

### 8. ✅ WebSocket события
- Все события отправляются корректно
- Подписка/отписка работают
- Аутентификация работает

## План исправлений

1. **Исправить логику одной ставки на аукцион**
   - Переместить SADD в начало placeBid
   - Убрать логику overbidding
   - Проверять ставку на уровне аукциона

2. **Добавить anti-sniping**
   - Проверка времени до окончания раунда
   - Блокировка в последние N секунд

3. **Исправить персистентность ставок**
   - Определить, как хранить ставки (на уровне аукциона или копировать в раунды)
   - Обновить settlement для использования правильных ставок

4. **Обновить recovery**
   - Восстанавливать ставки на правильном уровне

5. **Обновить frontend**
   - Блокировать повторные ставки
   - Показывать правильную информацию о ставках
