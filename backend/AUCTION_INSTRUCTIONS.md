# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–µ –∞—É–∫—Ü–∏–æ–Ω–æ–≤ - –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞

**Endpoint:** `POST /auctions`

**Request:**
```json
{
  "collection_id": "507f1f77bcf86cd799439011",
  "round_duration": 300,
  "gifts_per_round": 5
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
2. ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤ (–º–∞–∫—Å–∏–º—É–º 1 –∞–∫—Ç–∏–≤–Ω—ã–π)
3. ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `total_rounds = ceil(total_amount / gifts_per_round)`
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ MongoDB
5. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `start()`:
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis state –¥–ª—è —Ä–∞—É–Ω–¥–∞ 1
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –≤ MongoDB
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –≤ `auction:rounds:timeouts`
   - Broadcast —Å–æ–±—ã—Ç–∏—è `round_started`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê—É–∫—Ü–∏–æ–Ω —Å–æ–∑–¥–∞–Ω –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—â–µ–Ω.

---

## 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket

**URL:** `ws://localhost:3000/ws/auction?token={JWT_TOKEN}`

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- JWT —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ query –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `token`
- –¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```javascript
const ws = new WebSocket(`ws://localhost:3000/ws/auction?token=${jwtToken}`);
```

---

## 3. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∞—É–∫—Ü–∏–æ–Ω–∞

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```json
{
  "type": "subscribe",
  "data": {
    "auctionId": "507f1f77bcf86cd799439012"
  }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∞—É–∫—Ü–∏–æ–Ω–∞
- –ù–∞—á–∏–Ω–∞–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ –∞—É–∫—Ü–∏–æ–Ω–∞

**–°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å:**
- `bid_placed` - –Ω–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞
- `round_started` - –Ω–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞
- `round_closed` - –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–∞—É–Ω–¥–∞
- `round_settled` - settlement –∑–∞–≤–µ—Ä—à–µ–Ω
- `auction_finished` - –∞—É–∫—Ü–∏–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω

---

## 4. –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```json
{
  "type": "bid",
  "data": {
    "auctionId": "507f1f77bcf86cd799439012",
    "amount": 100
  }
}
```

**–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

### –®–∞–≥ 1: –í–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∞—É–∫—Ü–∏–æ–Ω–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ = `active`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ä–∞—É–Ω–¥ –∞–∫—Ç–∏–≤–µ–Ω (–Ω–µ settling)

### –®–∞–≥ 2: –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (1 —Å—Ç–∞–≤–∫–∞ = 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```redis
SADD auction:{id}:users {userId}
```
- –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0` ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É ‚Üí **–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ**
- –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `1` ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω ‚Üí **–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ**

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞: `balance - —Å—É–º–º–∞ –≤—Å–µ—Ö frozen`
- –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí **rollback** (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ SET) ‚Üí **–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ**

### –®–∞–≥ 4: –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤
```redis
SET user:{userId}:frozen:{auctionId} {amount}
```

### –®–∞–≥ 5: –ó–∞–ø–∏—Å—å —Å—Ç–∞–≤–∫–∏
```redis
ZADD auction:{id}:round:{n}:bids {amount} {userId}:{timestamp}:{amount}
```

### –®–∞–≥ 6: Broadcast
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `bid_placed` –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –∞—É–∫—Ü–∏–æ–Ω–∞

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –û–¥–Ω–∞ —Å—Ç–∞–≤–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤–µ—Å—å –∞—É–∫—Ü–∏–æ–Ω
- ‚ùå –°—Ç–∞–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞
- ‚ùå –°—Ç–∞–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–∞
- ‚ùå –ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

---

## 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–∞—É–Ω–¥–∞

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**

### –®–∞–≥ 1: RoundTimerService
- Worker –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `auction:rounds:timeouts` –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
- –ù–∞—Ö–æ–¥–∏—Ç –∏—Å—Ç–µ–∫—à–∏–µ —Ä–∞—É–Ω–¥—ã (–≥–¥–µ `round_end_ts <= now`)

### –®–∞–≥ 2: RoundService.closeRound()
1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ `settling = true` –≤ Redis
2. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞ –≤ MongoDB (`status = finished`, `ended_at = now`)
3. Broadcast —Å–æ–±—ã—Ç–∏—è `round_closed`
4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `SettlementService.settleRound()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è settlement.

---

## 6. Settlement (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π)

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ idempotency
```redis
GET auction:{id}:round:{n}:settled
```
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí **–ø—Ä–æ–ø—É—Å–∫** (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫
```redis
ZREVRANGE auction:{id}:round:{n}:bids 0 {gifts_per_round-1} WITHSCORES
```
- –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø-N —Å—Ç–∞–≤–æ–∫ (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Å—É–º–º–µ DESC)

### –®–∞–≥ 3: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ
- –ü–æ —Å—É–º–º–µ **DESC** (–±–æ–ª—å—à–µ = –ª—É—á—à–µ)
- –ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Üí –ø–æ timestamp **ASC** (—Ä–∞–Ω—å—à–µ = –ª—É—á—à–µ)

### –®–∞–≥ 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
- **–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏:** –ø–µ—Ä–≤—ã–µ `gifts_per_round` —Å—Ç–∞–≤–æ–∫
- **–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ:** –æ—Å—Ç–∞–ª—å–Ω—ã–µ

### –®–∞–≥ 5: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏:**
```typescript
deductBalance(userId, amount, auctionId)
```
- –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞
- –£–¥–∞–ª–µ–Ω–∏–µ frozen balance

**–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ:**
```typescript
unfreezeBalance(userId, amount, auctionId)
```
- –í–æ–∑–≤—Ä–∞—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
- –£–¥–∞–ª–µ–Ω–∏–µ frozen balance

### –®–∞–≥ 6: –û—á–∏—Å—Ç–∫–∞
- –£–¥–∞–ª–µ–Ω–∏–µ `auction:{id}:round:{n}:bids`
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `auction:{id}:round:{n}:settled = "1"`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `auction:{id}:state` (settling = false)

### –®–∞–≥ 7: Broadcast
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `round_settled` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è—Ö

### –®–∞–≥ 8: –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `AuctionService.nextRound()`

---

## 7. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤
- –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
- –ï—Å–ª–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–µ—Ç ‚Üí **–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞**

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
1. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç `current_round_number` –≤ MongoDB
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `current_round_started_at = now()`
3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞:
   - –ù–µ–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
   - + –ù–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –¥–æ `gifts_per_round`
4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis state –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –≤ `auction:rounds:timeouts`

### –®–∞–≥ 3: Broadcast
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `round_started` —Å –Ω–æ–≤—ã–º `roundNumber` –∏ `roundEndTs`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Å—Ç–∞–≤–∫–∏.

---

## 8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**

### –£—Å–ª–æ–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
1. –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
2. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥

### –®–∞–≥–∏:

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MongoDB:**
   - `status = finished`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Redis:**
   - `status = finished` –≤ `auction:{id}:state`

3. **–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤:**
   - `unfreezeAllForAuction(auctionId)` - –≤–æ–∑–≤—Ä–∞—Ç –≤—Å–µ—Ö –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤

4. **–û—á–∏—Å—Ç–∫–∞ Redis:**
   - –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–π `auction:{id}:*`

5. **Broadcast:**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `auction_finished`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê—É–∫—Ü–∏–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω, –≤—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.

---

## 9. Recovery –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ):**

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤
- –ó–∞–ø—Ä–æ—Å –∫ MongoDB: `status = active`

### –®–∞–≥ 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—É–∫—Ü–∏–æ–Ω–∞

1. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Redis state:**
   - –ò–∑ MongoDB: `current_round_number`, `current_round_started_at`
   - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `round_end_ts = started_at + round_duration`
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `auction:{id}:state`

2. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤:**
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `auction:rounds:timeouts`

3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤:**
   - –ß—Ç–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫ –∏–∑ `auction:{id}:round:{n}:bids`
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `user:{userId}:frozen:{auctionId}`
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `auction:{id}:users`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê—É–∫—Ü–∏–æ–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç—É —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞.

---

## 10. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏:

1. **"Auction not found"** ‚Üí –ê—É–∫—Ü–∏–æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. **"Auction is not active"** ‚Üí –ê—É–∫—Ü–∏–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω
3. **"Round is not accepting bids"** ‚Üí –†–∞—É–Ω–¥ –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ settling
4. **"User has already placed a bid"** ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É
5. **"Insufficient available balance"** ‚Üí –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤

### Rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:

–ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ SET:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ `auction:{id}:users`
- –û—Ç–∫–∞—Ç –∑–∞–º–æ—Ä–æ–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)

---

## 11. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—É–∫—Ü–∏–æ–Ω–µ:
**Endpoint:** `GET /auctions/{id}`

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞:
```typescript
const available = await walletService.getAvailableBalance(userId);
// = balance - —Å—É–º–º–∞ –≤—Å–µ—Ö frozen
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–¥–µ–ª–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–≤–∫—É:
```typescript
const hasBid = await bidService.hasUserBid(auctionId, userId);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
const bid = await bidService.getUserBid(auctionId, userId, roundNumber);
```

---

## 12. –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å–∏—Å—Ç–µ–º—ã:

1. **1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = 1 —Å—Ç–∞–≤–∫–∞** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π SADD
2. **–ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–µ–Ω** - –Ω–µ—Ç –¥–≤–æ–π–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π, –Ω–µ—Ç –ø–æ—Ç–µ—Ä—å —Å—Ä–µ–¥—Å—Ç–≤
3. **–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–º –¥–µ–Ω—å–≥–∏ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ settlement
4. **–ù–µ—Ç –≥–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö** - –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ Redis
5. **–ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–∞–≤–¥—ã** - MongoDB –¥–ª—è persistence, Redis –¥–ª—è runtime
6. **–ù–µ–≤–æ–∑–º–æ–∂–µ–Ω –¥–≤–æ–π–Ω–æ–π settlement** - –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ –∫–ª—é—á `settled`

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

1. –ú–∞–∫—Å–∏–º—É–º 1 –∞–∫—Ç–∏–≤–Ω—ã–π –∞—É–∫—Ü–∏–æ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. –°—Ç–∞–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞
3. –†–∞—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É
4. Settlement –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞—É–Ω–¥–∞

### üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:

1. –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–∞—É–Ω–¥–æ–≤ –ø–æ —Ç–∞–π–º–µ—Ä—É (RoundTimerService)
2. Settlement –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞—É–Ω–¥–∞
3. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É –ø–æ—Å–ª–µ settlement
4. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
5. Recovery –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞

---

## 13. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `pino`:

- `bid_placed` - —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
- `round_closed` - –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–∞—É–Ω–¥–∞  
- `round_settled` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ settlement
- `round_started` - –Ω–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞
- `auction_finished` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞

**–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:**
```json
{
  "level": "info",
  "time": 1234567890,
  "name": "bidService",
  "userId": 123,
  "auctionId": "...",
  "roundNumber": 1,
  "amount": 100,
  "msg": "Bid placed successfully"
}
```

---

## 14. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. **–°–æ–∑–¥–∞—Ç—å –∞—É–∫—Ü–∏–æ–Ω** —á–µ—Ä–µ–∑ POST /auctions
2. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket** —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. **–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è** –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω
4. **–†–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Ç–∞–≤–∫—É** —á–µ—Ä–µ–∑ WebSocket
5. **–î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞—É–Ω–¥–∞** (–ø–æ —Ç–∞–π–º–µ—Ä—É)
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å settlement** (–ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å–∞–Ω—ã/–≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã)
7. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É** (–Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ —Å–æ–∑–¥–∞–Ω)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ recovery:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å –∞–∫—Ç–∏–≤–Ω—ã–º –∞—É–∫—Ü–∏–æ–Ω–æ–º
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–Ω–æ–≤–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞—É–∫—Ü–∏–æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–∞:
- ‚úÖ –ê—É–∫—Ü–∏–æ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –†–∞—É–Ω–¥—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É
- ‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –°—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è/–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ê—É–∫—Ü–∏–æ–Ω—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** —Ç–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —á–µ—Ä–µ–∑ WebSocket.

