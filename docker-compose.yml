services:
    mongodb:
        image: mongo:8.0
        container_name: auction-mongodb
        restart: unless-stopped
        ports:
            - "27017:27017"
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
            MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-auction_db}
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        networks:
            - auction-network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        container_name: auction-redis
        restart: unless-stopped
        ports:
            - "6379:6379"
        command: redis-server --requirepass ${REDIS_PASSWORD:-redispassword} --appendonly yes
        volumes:
            - redis_data:/data
        networks:
            - auction-network
        healthcheck:
            test:
                [
                    "CMD",
                    "redis-cli",
                    "-a",
                    "${REDIS_PASSWORD:-redispassword}",
                    "ping",
                ]
            interval: 10s
            timeout: 3s
            retries: 5

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: auction-backend
        restart: unless-stopped
        ports:
            - "${BACKEND_PORT:-8080}:8080"
        environment:
            NODE_ENV: ${NODE_ENV:-production}
            HOST: ${HOST:-0.0.0.0}
            PORT: ${PORT:-8080}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
            MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DATABASE:-auction_db}?authSource=admin
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
            COMMON_RATE_LIMIT_MAX_REQUESTS: ${COMMON_RATE_LIMIT_MAX_REQUESTS:-1000}
            COMMON_RATE_LIMIT_WINDOW_MS: ${COMMON_RATE_LIMIT_WINDOW_MS:-1000}
            TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - auction-network
        volumes:
            - ./backend:/app
            - /app/node_modules

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            target: dev
        container_name: auction-frontend
        restart: unless-stopped
        ports:
            - "${FRONTEND_PORT:-5173}:5173"
        environment:
            VITE_API_URL: ${VITE_API_URL:-http://localhost:8080}
        depends_on:
            - backend
        networks:
            - auction-network
        volumes:
            - ./frontend:/app
            - /app/node_modules

    prometheus:
        image: prom/prometheus:latest
        container_name: auction-prometheus
        restart: unless-stopped
        ports:
            - "${PROMETHEUS_PORT:-9090}:9090"
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--web.console.libraries=/usr/share/prometheus/console_libraries"
            - "--web.console.templates=/usr/share/prometheus/consoles"
            - "--storage.tsdb.retention.time=30d"
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus_data:/prometheus
        networks:
            - auction-network
        depends_on:
            - backend
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:9090/-/healthy",
                ]
            interval: 10s
            timeout: 5s
            retries: 5

    grafana:
        image: grafana/grafana:latest
        container_name: auction-grafana
        restart: unless-stopped
        ports:
            - "${GRAFANA_PORT:-3000}:3000"
        environment:
            GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
            GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
            GF_USERS_ALLOW_SIGN_UP: "false"
            GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3000}
        volumes:
            - grafana_data:/var/lib/grafana
            - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
            - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
        networks:
            - auction-network
        depends_on:
            prometheus:
                condition: service_healthy

volumes:
    mongodb_data:
    mongodb_config:
    redis_data:
    prometheus_data:
    grafana_data:

networks:
    auction-network:
        driver: bridge
