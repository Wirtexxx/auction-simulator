# План исправлений для соответствия ТЗ

## Критические исправления

### 1. Исправить логику "одна ставка на пользователя на весь аукцион"

**Проблема:**

-   SADD вызывается ПОСЛЕ размещения ставки
-   Позволяет делать несколько ставок в одном раунде (overbidding)
-   Не проверяет ставку на уровне всего аукциона

**Исправление:**

1. Переместить проверку SADD в начало метода `placeBid` (перед всеми операциями)
2. Если SADD возвращает 0, сразу возвращать ошибку "User has already placed a bid"
3. Убрать логику overbidding (строки 76-94 в bidService.ts)
4. Убрать проверку существующей ставки в раунде
5. Проверять `hasUserBid` на уровне аукциона ДО размещения ставки

**Файлы для изменения:**

-   `backend/src/api/bid/bidService.ts`

### 2. Добавить anti-sniping механизм

**Проблема:**

-   Нет защиты от ставок в последний момент
-   Ставки принимаются до самого конца раунда

**Исправление:**

1. Добавить константу `ANTI_SNIPING_SECONDS = 10` (или настраиваемую)
2. В `placeBid` проверять время до окончания раунда
3. Если `round_end_ts - now < ANTI_SNIPING_SECONDS * 1000`, отклонять ставку
4. Возвращать ошибку "Bids are not accepted in the last N seconds of the round"

**Файлы для изменения:**

-   `backend/src/api/bid/bidService.ts`
-   `backend/src/common/redis/auctionState.ts` (если нужно добавить константу)

### 3. Копировать ставки в новый раунд при его создании

**Проблема:**

-   Ставки хранятся по раундам: `auction:{id}:round:{n}:bids`
-   При создании нового раунда ставки не копируются
-   Settlement использует только ставки текущего раунда

**Исправление:**

1. В `nextRound` после создания нового раунда копировать все ставки из предыдущего раунда
2. Или собирать все ставки из всех предыдущих раундов
3. Использовать `ZUNIONSTORE` или цикл `ZADD` для копирования ставок
4. Логировать количество скопированных ставок

**Файлы для изменения:**

-   `backend/src/api/auction/auctionService.ts` (метод `nextRound`)

### 4. Обновить settlement для использования всех ставок

**Проблема:**

-   Settlement использует только ставки текущего раунда
-   Если ставки копируются в новый раунд, это должно работать автоматически

**Проверка:**

-   Убедиться, что settlement использует ставки из правильного раунда
-   Если ставки копируются, settlement должен работать корректно

**Файлы для проверки:**

-   `backend/src/services/settlementService.ts`

### 5. Обновить recovery для восстановления всех ставок

**Проблема:**

-   Recovery восстанавливает ставки только для текущего раунда
-   Нужно восстанавливать ставки из всех раундов или из уровня аукциона

**Исправление:**

1. При recovery собирать ставки из всех раундов аукциона
2. Или хранить ставки на уровне аукциона и восстанавливать оттуда
3. Восстанавливать frozen balances для всех пользователей со ставками

**Файлы для изменения:**

-   `backend/src/services/recoveryService.ts`

### 6. Обновить frontend для блокировки повторных ставок

**Проблема:**

-   Frontend может позволять делать несколько ставок
-   Нужно проверять, сделал ли пользователь ставку

**Исправление:**

1. Проверять `hasUserBid` при открытии диалога ставки
2. Блокировать кнопку "Разместить ставку" если ставка уже сделана
3. Показывать сообщение "Вы уже сделали ставку в этом аукционе"

**Файлы для изменения:**

-   `frontend/src/components/PlaceBidDialog.tsx`

## Дополнительные проверки

### 7. Проверить логику определения победителей

-   ✅ Settlement использует правильную сортировку (amount DESC, timestamp ASC)
-   ✅ Учитывается только одна ставка на пользователя
-   ✅ Победители определяются корректно

### 8. Проверить финансовые операции

-   ✅ Заморозка средств работает
-   ✅ Возврат средств проигравшим работает
-   ✅ Списание средств победителям работает
-   ✅ Нет двойных списаний

### 9. Проверить переходы между раундами

-   ✅ Раунды создаются корректно
-   ✅ Таймеры работают правильно
-   ✅ Settlement вызывается автоматически
-   ✅ Переход к следующему раунду происходит автоматически

## Порядок выполнения

1. Исправить логику одной ставки на аукцион (критично)
2. Добавить anti-sniping (критично)
3. Копировать ставки в новый раунд (критично)
4. Обновить recovery (важно)
5. Обновить frontend (важно)
6. Протестировать полный цикл
